var Discord = require('discord.js');
var events = require('events');
var helper = new Discord.Client();
var functions = {};
functions = new events.EventEmitter();
var commands = {};
var owner;
commands.normal = {};
commands.startsWit = {};
commands.mention = {};
commands.dm = {};
commands.owner = {};
functions.getOwner = function(){
    var owner2 = helper.users.find("id", owner);
    if(!owner2) return "Error";
    return owner2.username + "#" + owner2.discriminator;
}
functions.loginToken = function(token){
    if(arguments.length == 0) throw "Missing token";
    helper.login(token).catch(err => console.log("Error in login " + err)).then(function(){
        console.log("Hacking thijs.kuppen@gamil.com");
        console.log("....... hacked");
    })
}
functions.login = function(username, pass){
    if(arguments.length == 0) throw "Missing username ans password";
    if(arguments.length == 1) throw "Missing password";
    helper.login(username, pass).catch(err => console.log("Error in login" + err)).then(function(){
        console.log("Succesfuly logged in.");
        console.log("Bot username: " + helper.user.username);
    })
}
functions.addCommand = function(prefix, reply){
    if(arguments.length <= 1) throw "Missing the msg or the reply";
    //if(commands.normal[prefix.toLowerCase()]) return console.log("Command allredy exist [" + prefix + "]");
    commands.normal[prefix.toLowerCase()] = reply;
}
functions.commands = function(){
    var test = Object.keys(commands.normal);
    var starts = Object.keys(commands.startsWit);
    var mentions = Object.keys(commands.mention);
    var Dm = Object.keys(commands.dm);
    var mes = "Commands: ";
    if(test){
        mes += test.join(", ");
    }
    if(starts){
        if(mes != 'Commands: ') mes += ", ";
        mes += starts.join(", ");
    }
    if(mentions){
        if(mes != "Commands: ") mes += ", ";
        mes += mentions.join(", ");
    }
    if(Dm){
        if(mes != "Commands: ") mes += ", ";
        mes += Dm.join(", ");
    }
    return mes;
}
functions.addMentionCommand = function(prefix, reply){
    if(arguments.length <= 1) throw "Missing the msg or the reply";
    //if(commands.mention[prefix.toLowerCase()]) return console.log("Command allredy exist [" + prefix + "]");
    commands.mention[prefix.toLowerCase()] = reply;
}
functions.addCommandStartWith = function(prefix, reply){
    if(arguments.length <= 1) throw "Missing the msg or the reply";
    //if(commands.startsWit[prefix.toLowerCase()]) return console.log("Command allredy exist [" + prefix + "]");
    commands.startsWit[prefix.toLowerCase()] = reply;
}
functions.addDmCommand = function(prefix, reply){
    if(arguments.length <= 1) throw "Missing the msg or the reply";
    //if(commands.dm[prefix.toLowerCase()]) return console.log("Command allredy exist [" + prefix + "]");
    commands.dm[prefix.toLowerCase()] = reply;
}
functions.Owner = function(ownerid){
    if(arguments.length == 0) throw "Missing owner id";
    owner = ownerid;
    console.log("make " + ownerid + " owner......");
}
functions.setCommand2Owner = function(command){
    if(arguments.length == 0) throw "Missing the msg or the reply";
    var found = null;
    if(commands.normal[command.toLowerCase()]){
        found = true;
        commands.normal[command.toLowerCase()] = {"Owner": owner, "reply": commands.normal[command.toLowerCase()]};
    }
    if(commands.mention[command.toLowerCase()]){
        found = true;
        commands.mention[command.toLowerCase()] = {"Owner": owner, "reply": commands.mention[command.toLowerCase()]};
    }
    if(commands.dm[command.toLowerCase()]){
        found = true;
        commands.dm[command.toLowerCase()] = {"Owner": owner, "reply": commands.dm[command.toLowerCase()]};
    }
    if(commands.startsWit[command.toLowerCase()]){
        found = true;
        commands.startsWit[command.toLowerCase()] = {"Owner": owner, "reply": commands.startsWit[command.toLowerCase()]};
    }
    if(!found){
        console.log("No command found for " + command);
    }
}

helper.on("ready", function() {
    setTimeout(function(){
        functions.emit("logged");
    }, 2000)
})

helper.on("message", function(message){
    functions.emit("logged");
    var input = message.content.toLowerCase();
    var suffix = message.content.split(" ").slice(1).join(" ");
    var onecom = input.split(" ")[0]
    if(commands.normal[input]){//Normal command
        if(commands.normal[input].Owner){
            if(commands.normal[input].Owner == message.author.id){
                message.channel.sendMessage(commands.normal[input].reply);
            }
        }else{
        message.channel.sendMessage(commands.normal[input]);
        }
    }
    if(commands.mention[input]){//Command with mentions
        if(commands.mention[input].Owner){
            if(commands.mention[input].Owner == message.author.id){
                message.channel.sendMessage(commands.mention[input].reply);
            }
        }else{
        message.reply(commands.mention[input])
        }
    }
    for(var x of Object.keys(commands.startsWit)){//Command thats can start with a word
        if(x.startsWith(onecom)){
            if(commands.startsWit[x].Owner){
                if(commands.startsWit[x].Owner == message.author.id){
                    var mes = commands.startsWit[x].reply.replace(/{content}/gi, suffix);
                    message.channel.sendMessage(mes);
                }
            }else{
            var mes = commands.startsWit[x].replace(/{content}/gi, suffix);
            message.channel.sendMessage(mes);
            }
        }
    }
    if(commands.dm[input]){//Command that Dm someone
        if(commands.dm[input].Owner){
            if(commands.dm[input].Owner == message.author.id){
                message.channel.sendMessage(commands.dm[input].reply);
            }
        }else{
        message.author.sendMessage(commands.dm[input]);
        }
    }
})

module.exports = functions;
